---
# preCICE Configuration Topology for Two-Scale Heat Conduction Example
version: 1.0

configuration:
  type: precice
  dimensions: 2
  experimental: true

logging:
  enabled: true
  sink:
    type: stream
    output: stdout
    filter: "%Severity% > debug"

data:
  - name: k_00
    type: scalar
  - name: k_01
    type: scalar
  - name: k_10
    type: scalar
  - name: k_11
    type: scalar
  - name: porosity
    type: scalar
  - name: concentration
    type: scalar
  - name: micro_sim_time
    type: scalar
  - name: grain_size
    type: scalar
  - name: active_state
    type: scalar
  - name: active_steps
    type: scalar

meshes:
  - name: macro-mesh
    dimensions: 2
    data: 
      - k_00
      - k_01
      - k_10
      - k_11
      - porosity
      - concentration
      - micro_sim_time
      - grain_size
      - active_state
      - active_steps

participants:
  - name: macro-heat
    provides_mesh: 
      - macro-mesh
    reads_data:
      - name: k_00
        mesh: macro-mesh
      - name: k_01
        mesh: macro-mesh
      - name: k_10
        mesh: macro-mesh
      - name: k_11
        mesh: macro-mesh
      - name: porosity
        mesh: macro-mesh
    writes_data:
      - name: concentration
        mesh: macro-mesh

  - name: Micro-Manager
    receives_mesh:
      - name: macro-mesh
        from: macro-heat
        direct_access: true
        safety_factor: 0.0
    reads_data:
      - name: concentration
        mesh: macro-mesh
    writes_data:
      - name: k_00
        mesh: macro-mesh
      - name: k_01
        mesh: macro-mesh
      - name: k_10
        mesh: macro-mesh
      - name: k_11
        mesh: macro-mesh
      - name: porosity
        mesh: macro-mesh
      - name: micro_sim_time
        mesh: macro-mesh
      - name: grain_size
        mesh: macro-mesh
      - name: active_state
        mesh: macro-mesh
      - name: active_steps
        mesh: macro-mesh
    export:
      type: vtu
      directory: precice-exports

communication:
  type: sockets
  acceptor: Micro-Manager
  connector: macro-heat
  network: lo
  exchange_directory: ..

coupling_scheme:
  type: serial-implicit
  max_time: 0.02
  time_window_size: 1.0e-2
  max_iterations: 30
  participants:
    - first: macro-heat
    - second: Micro-Manager
  data_exchange:
    - data: k_00
      mesh: macro-mesh
      from: Micro-Manager
      to: macro-heat
    - data: k_01
      mesh: macro-mesh
      from: Micro-Manager
      to: macro-heat
    - data: k_10
      mesh: macro-mesh
      from: Micro-Manager
      to: macro-heat
    - data: k_11
      mesh: macro-mesh
      from: Micro-Manager
      to: macro-heat
    - data: porosity
      mesh: macro-mesh
      from: Micro-Manager
      to: macro-heat
    - data: concentration
      mesh: macro-mesh
      from: macro-heat
      to: Micro-Manager
      initialize: true
  convergence_measures:
    - data: k_00
      mesh: macro-mesh
      type: relative
      limit: 1e-3
    - data: k_11
      mesh: macro-mesh
      type: relative
      limit: 1e-3
    - data: porosity
      mesh: macro-mesh
      type: relative
      limit: 1e-3
    - data: concentration
      mesh: macro-mesh
      type: relative
      limit: 1e-3
  acceleration:
    type: IQN-ILS
    data:
      - name: k_00
        mesh: macro-mesh
      - name: k_11
        mesh: macro-mesh
      - name: porosity
        mesh: macro-mesh
    preconditioner:
      type: residual-sum
    initial_relaxation: 0.9
    max_used_iterations: 40
    time_windows_reused: 20
    filter:
      type: QR2
      limit: 1e-2
